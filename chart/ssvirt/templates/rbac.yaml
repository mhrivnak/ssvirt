{{- if .Values.rbac.create }}
# API Server RBAC - includes embedded Kubernetes management capabilities
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: {{ include "ssvirt.fullname" . }}-api-server
  labels:
    {{- include "ssvirt.labels" . | nindent 4 }}
    app.kubernetes.io/component: api-server
  {{- $rbacAnnotations := .Values.rbac.annotations | default dict }}
  {{- $commonAnnotations := include "ssvirt.annotations" . | fromYaml | default dict }}
  {{- $mergedAnnotations := merge $rbacAnnotations $commonAnnotations }}
  {{- if $mergedAnnotations }}
  annotations:
    {{- toYaml $mergedAnnotations | nindent 4 }}
  {{- end }}
rules:
# Namespace management permissions for VDCs
- apiGroups: [""]
  resources: ["namespaces"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
# Events for logging
- apiGroups: [""]
  resources: ["events"]
  verbs: ["create", "patch"]
# ServiceAccounts in VDC namespaces
- apiGroups: [""]
  resources: ["serviceaccounts"]
  verbs: ["get", "list", "watch", "create", "update", "patch"]
# Secrets in VDC namespaces
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "list", "watch", "create", "update", "patch"]
# ConfigMaps in VDC namespaces
- apiGroups: [""]
  resources: ["configmaps"]
  verbs: ["get", "list", "watch", "create", "update", "patch"]
# ResourceQuotas for VDC resource management
- apiGroups: [""]
  resources: ["resourcequotas"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
# LimitRanges for VDC resource management
- apiGroups: [""]
  resources: ["limitranges"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
# NetworkPolicies for VDC isolation
- apiGroups: ["networking.k8s.io"]
  resources: ["networkpolicies"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
# RBAC for tenant permissions
- apiGroups: ["rbac.authorization.k8s.io"]
  resources: ["roles", "rolebindings"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
# OpenShift Virtualization resources
- apiGroups: ["kubevirt.io"]
  resources: ["virtualmachines", "virtualmachineinstances"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: ["instancetype.kubevirt.io"]
  resources: ["virtualmachineinstancetypes", "virtualmachineclusterinstancetypes"]
  verbs: ["get", "list", "watch"]
# OpenShift networking
- apiGroups: ["k8s.ovn.org"]
  resources: ["userdefinednetworks"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
# OpenShift Templates for catalog integration
- apiGroups: ["template.openshift.io"]
  resources: ["templates"]
  verbs: ["get", "list", "watch"]
# Template instances for VM creation
- apiGroups: ["template.openshift.io"]
  resources: ["templateinstances"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
# Template configurations for VM creation
- apiGroups: ["template.openshift.io"]
  resources: ["templateconfigs"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: {{ include "ssvirt.fullname" . }}-api-server
  labels:
    {{- include "ssvirt.labels" . | nindent 4 }}
    app.kubernetes.io/component: api-server
  {{- $rbacAnnotations := .Values.rbac.annotations | default dict }}
  {{- $commonAnnotations := include "ssvirt.annotations" . | fromYaml | default dict }}
  {{- $mergedAnnotations := merge $rbacAnnotations $commonAnnotations }}
  {{- if $mergedAnnotations }}
  annotations:
    {{- toYaml $mergedAnnotations | nindent 4 }}
  {{- end }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: {{ include "ssvirt.fullname" . }}-api-server
subjects:
- kind: ServiceAccount
  name: {{ include "ssvirt.serviceAccountName" . }}
  namespace: {{ .Release.Namespace }}

{{- if .Values.vmController.enabled }}
---
# VM Controller RBAC - for VM status synchronization
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: {{ include "ssvirt.fullname" . }}-vm-controller
  labels:
    {{- include "ssvirt.labels" . | nindent 4 }}
    app.kubernetes.io/component: vm-controller
  {{- $rbacAnnotations := .Values.rbac.annotations | default dict }}
  {{- $commonAnnotations := include "ssvirt.annotations" . | fromYaml | default dict }}
  {{- $mergedAnnotations := merge $rbacAnnotations $commonAnnotations }}
  {{- if $mergedAnnotations }}
  annotations:
    {{- toYaml $mergedAnnotations | nindent 4 }}
  {{- end }}
rules:
# Watch and update VirtualMachine resources across all namespaces
- apiGroups: ["kubevirt.io"]
  resources: ["virtualmachines"]
  verbs: ["get", "list", "watch", "update", "patch"]
# Read VM status and specs
- apiGroups: ["kubevirt.io"]
  resources: ["virtualmachines/status"]
  verbs: ["get", "list"]
# Watch VirtualMachineInstance resources for runtime data
- apiGroups: ["kubevirt.io"]
  resources: ["virtualmachineinstances"]
  verbs: ["get", "list", "watch"]
# Read VMI status for runtime information
- apiGroups: ["kubevirt.io"]
  resources: ["virtualmachineinstances/status"]
  verbs: ["get", "list"]
# Access TemplateInstances to lookup vApp names
- apiGroups: ["template.openshift.io"]
  resources: ["templateinstances"]
  verbs: ["get", "list", "watch"]
# Create events for tracking and debugging
- apiGroups: [""]
  resources: ["events"]
  verbs: ["create", "patch"]
# Access to all VDC namespaces (managed by SSVirt)
- apiGroups: [""]
  resources: ["namespaces"]
  verbs: ["get", "list"]
# Leader election coordination
- apiGroups: ["coordination.k8s.io"]
  resources: ["leases"]
  verbs: ["get", "list", "watch", "create", "update", "patch"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: {{ include "ssvirt.fullname" . }}-vm-controller
  labels:
    {{- include "ssvirt.labels" . | nindent 4 }}
    app.kubernetes.io/component: vm-controller
  {{- $rbacAnnotations := .Values.rbac.annotations | default dict }}
  {{- $commonAnnotations := include "ssvirt.annotations" . | fromYaml | default dict }}
  {{- $mergedAnnotations := merge $rbacAnnotations $commonAnnotations }}
  {{- if $mergedAnnotations }}
  annotations:
    {{- toYaml $mergedAnnotations | nindent 4 }}
  {{- end }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: {{ include "ssvirt.fullname" . }}-vm-controller
subjects:
- kind: ServiceAccount
  name: {{ include "ssvirt.fullname" . }}-vm-controller
  namespace: {{ .Release.Namespace }}

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ include "ssvirt.fullname" . }}-vm-controller
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "ssvirt.labels" . | nindent 4 }}
    app.kubernetes.io/component: vm-controller
  {{- $saAnnotations := .Values.serviceAccount.annotations | default dict }}
  {{- $commonAnnotations := include "ssvirt.annotations" . | fromYaml | default dict }}
  {{- $mergedAnnotations := merge $saAnnotations $commonAnnotations }}
  {{- if $mergedAnnotations }}
  annotations:
    {{- toYaml $mergedAnnotations | nindent 4 }}
  {{- end }}
{{- end }}
{{- end }}